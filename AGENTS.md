# AIアシスタント向けガイド（臨床疫学R環境）

このリポジトリは、臨床疫学研究でよく使う統計解析をRで再現可能に実行するための環境と例を提供します。

この `AGENTS.md` は、**統計初心者がAIと一緒に解析を進める**ときに破綻しにくいよう、最低限のガードレール（確認事項・禁止事項・既定の進め方）をまとめたものです。

> [!IMPORTANT]

> AIは「統計的に重要な判断」を勝手に確定しないでください。選択肢とメリット・デメリットを示し、**ユーザーの意図（研究目的・デザイン・推定対象）を確認**して進めます。

## リポジトリ構造（よく触る場所）

-`principles/`：臨床疫学研究の統計原則（最重要）

-`docs/`：環境・使い方・注意点・トラブルシューティング

-`scripts/`：解析スクリプトと実例（`zenodo_analysis/`, `plos_analysis/` など）

-`data/`：サンプル/公開データ置き場（機密データは置かない）

## まず参照するドキュメント（優先順）

1.`principles/compiled_principles.md`（推定値+CI、欠測、二値化回避、多重比較、クラスタリング等）

2.`docs/r_usage_examples.md`（代表的な解析の形）

3.`docs/iptw_note.md`（`iptw`ではなく `WeightIt` を使う理由と注意）

4.`docs/troubleshooting.md`（環境・パッケージ・実行エラーの対処）

5.`docs/summary.md`, `docs/r_environment_setup.md`, `docs/r_update_summary.md`（全体像と注意点）

> [!NOTE]

> 一部ドキュメントに `~/statistical_principles/...` のような古いパス表記が出る場合は、基本的にこのリポジトリ内のパス（例：`scripts/...`）に読み替えてください。

## スキル（再利用可能なスクリプト）

解析をゼロから書き始めず、既存スクリプトをテンプレとして再利用します（必要に応じて `scripts/<analysis_name>/` にコピーして編集）。

### 基本スキル

| スクリプト | 説明 | 使用パッケージ |
|-----------|------|---------------|
| `scripts/updated_example.R` | 包括的な臨床疫学解析の例。記述統計、可視化、回帰分析、傾向スコア解析を含む | tidyverse, ggplot2, gtsummary, WeightIt |
| `scripts/simple_demo.R` | パッケージの基本使用法のデモ | tidyverse, gtsummary |
| `scripts/verify_packages.R` | パッケージのインストール確認 | - |

### 高度な解析スキル

#### PLOS Analysis（生存分析）：`scripts/plos_analysis/`

| スクリプト | 説明 |
|-----------|------|
| `scripts/plos_analysis/cox_model_analysis.R` | Cox比例ハザードモデルによる生存分析 |
| `scripts/plos_analysis/fixed_cox_analysis.R` | 修正版Cox分析（多変量調整） |
| `scripts/plos_analysis/data_exploration.R` | データ探索と前処理 |

#### Zenodo Analysis（時系列予測）：`scripts/zenodo_analysis/`

| スクリプト | 説明 |
|-----------|------|
| `scripts/zenodo_analysis/zenodo_data_analysis.R` | ECDCデータを用いた記述統計・可視化 |
| `scripts/zenodo_analysis/spain_prediction_model.R` | 時系列予測モデル（ARIMA等） |

## 統計原則ドキュメント（`principles/`）

最優先は `principles/compiled_principles.md`（上の「まず参照するドキュメント（優先順）」参照）。

| ファイル | 内容 |
|---------|------|
| `principles/strobe_principles.md` | STROBE statementからの統計原則 |
| `principles/bmj_principles.md` | BMJ統計ガイドライン |
| `principles/jama_principles.md` | JAMA著者向け統計指示 |

## エージェント利用ガイド（スクリプト選択）

### 解析タスクへの対応

1. **新しい臨床疫学解析を行う場合**
   - まず `principles/compiled_principles.md` を参照し、統計原則を確認
   - `scripts/updated_example.R` をテンプレートとして活用
   - 解析の分割・保存ルールは「新規解析追加のワークフロー」も参照

2. **生存分析を行う場合**
   - `scripts/plos_analysis/fixed_cox_analysis.R` を参照
   - Cox比例ハザードモデル、Kaplan-Meier曲線の作成例あり

3. **傾向スコア解析を行う場合**
   - `scripts/updated_example.R` のExample 4を参照
   - WeightItパッケージによるIPTW（逆確率重み付け）の実装例

4. **時系列データ分析を行う場合**
   - `scripts/zenodo_analysis/spain_prediction_model.R` を参照

### 使用可能なRパッケージ（主要）

| パッケージ | 用途 |
|-----------|------|
| tidyverse | データ操作の基盤 |
| ggplot2 | データ可視化 |
| dplyr | データ変換・集計 |
| gtsummary | 出版品質の統計表作成 |
| WeightIt | 傾向スコア・逆確率重み付け |
| survival | 生存分析 |

## Human-in-the-loop 計画の立て方（必須）

解析計画は「AIが勝手に進めない」ための**合意文書**です。以下を必ず明記し、節目ごとにユーザー確認を取ってから実装へ進みます。

### 1) 計画に必ず書く合意ポイント

-**データ辞書**：実データの `names()` / `str()` を確認し、論文表記との**対応表**を作る（例：MBP=MAP、RRT=CRRT）。
-**主要変数定義**：アウトカムのイベント・観察時間・検閲定義、参照カテゴリ、単位・変換（例：BMI区分、中心化）。
-**モデル仕様**：使う共変量・除外ルール（例：VIF閾値、SAPSIIの扱い）を**式として**明記。
-**出力仕様**：ファイル名と形式（PNG+PDF）、表の列名・並び順を明記。

### 2) ユーザー確認ゲート（HITL）

- Gate A: データ辞書と対応表を提示 → ユーザー承認。
- Gate B: 主要変数定義（特に生存時間・参照カテゴリ）を提示 → 承認。
- Gate C: 解析モデル（式・除外ルール）を提示 → 承認。
- Gate D: 期待する出力一覧（表/図/ファイル名）を提示 → 承認。

### 3) 小さな検証を先に

- まず **小サンプル**または **最小構成**で動作確認（変数名・式・出力が一致するか）。
- 基本指標（件数、イベント数、主要割合）を**計画値/論文値**と比較し、差分を報告。

### 4) 差分が出たら計画を更新

- データ辞書不一致やモデル仕様変更が必要なら、**計画の差分を明示**して再承認を取る。
- `options(warn = -1)` のような**警告抑制は原則しない**（必要なら一時的にし、理由と影響を記録）。

## 統計初心者向け：解析ガードレール

### 1) 解析依頼テンプレ（最初にユーザーへ確認）

ユーザーの回答が揃うほど、無駄なやり直しと誤解が減ります。最低限、以下を確認してください。

**研究の目的**

- 何を知りたい？（記述 / 予後因子 / 予測 / 因果効果 / 探索）
- 結果をどう使う？（論文、院内報告、意思決定の補助など）

**研究デザイン**

- 観察研究（コホート/症例対照/横断）か、介入か
- データの単位（患者/入院/受診/測定）と、独立性（同一患者の繰り返し測定・施設クラスタ等）

**変数定義（最重要）**

- アウトカム（型：連続/二値/カウント/時間-to-イベント、測定タイミング、検閲の定義）
- 曝露/介入（群の定義、開始時点、時間依存の有無）
- 調整候補（交絡・共変量、事前に入れる変数の考え方）
- 変数のコード（0/1の意味、単位、異常値コード（例：999））

**欠測と除外**

- 欠測の量、欠測が起きる理由の見当、除外基準（完全ケース分析は原則推奨されにくいので要相談）

**報告形式**

- 効果指標（差/OR/RR/HR など）と、必ず95%CIも出すか
- 図表の希望（Table1、回帰表、KM曲線、バランスプロット等）

> [!TIP]

> ユーザーが迷っている場合は、まず「記述統計＋欠測要約＋簡単な可視化」までを先に作り、次にモデル化へ進める。

### 2) 実データを触る前の最低限チェック（勝手に省略しない）

-`n`（行数）と主要イベント数（アウトカムが二値/生存なら特に）

- 変数の型（数値/因子/日付）と単位
- 欠測のパターン（列ごとの欠測率、主要変数の欠測）
- あり得ない値（年齢<0、BMI極端、999等のコード）
- **イベント変数のカテゴリ（0/1/2/...の意味）を`table()`で確認**し、論文記載と対応づける

> [!CAUTION]
>
> **変数のコーディングを「推定」してコードを書かない**。イベント変数（status、event等）は必ず`table(df$status)`等で実際のカテゴリを確認し、論文記載の件数と照合してからコードに落とす。この手順を省略すると、生存解析等で全く異なる結果が出て、デバッグに時間を浪費する。

### 3) 必ずユーザー確認が必要な判断（例）

以下は結果が大きく変わり得るため、**選択肢を提示して確認**してください。

- 研究目的の分類（因果推論か、関連の記述か、予測か）
- 主要アウトカム/副次アウトカム、主要解析/感度解析の区別（多重比較の扱い）
- 欠測の扱い（完全ケースで進めるか、多重代入か、別法か）
- 連続変数の扱い（原則二値化しない；非線形を許すか等）
- クラスタリング/繰り返し測定の扱い（混合効果/ロバストSE等）
- 変数選択（p値だけで選ばない；原則は事前知識）
- 観察研究での因果効果の言い方（因果語を避ける/前提を明記）
- 傾向スコア法の推定対象（ATE/ATT）と、トリミング等のルール

### 4) デフォルトで進めてよい低リスク手順（ユーザーが未指定のとき）

- まずは `tbl_summary()` で全体/群別の記述統計（平均±SDやn(%)など）を作る
- 推定値＋95%CIを中心に整理し、p値だけの結論にしない（`principles/compiled_principles.md`参照）
- p値を示す場合は「P < 0.05」ではなく実値（例：`P = 0.043`）を使う
- 乱数を使う処理（サンプリング、分割、代入等）がある場合は `set.seed(123)` を明示
- 解析が重い/長い場合は、先に小さなサンプルで動作確認してから本番に進む
- 大規模データはメモリ使用量に注意し、列選択や集計から始める（`docs/summary.md`参照）

### 5) トラブルシューティング：最初の3手

- 実行コマンドとエラーメッセージ全文を確認（省略しない）

-`sessionInfo()`、`packageVersion()`、データの `str()`/`names()` で状況を切り分け

- 関数の衝突が疑わしい場合は `pkg::fun()` で明示（詳細は `docs/troubleshooting.md`）

## 因果推論（傾向スコア/IPTW）を扱うときの追加ガードレール

- このリポジトリでは `iptw` の代替として `WeightIt` を使用（`docs/iptw_note.md`）。

-**極端な傾向スコア（0/1付近）や極端な重み**が出る場合は、推定が不安定になりやすい：ユーザーに状況を報告し、トリミング等の選択肢を提示する（`docs/troubleshooting.md`にも例あり）。

-**バランス確認**（例：`WeightIt::summary()`、可能なら `cobalt` で `bal.tab()`/`love.plot()`）を必ず行い、結果（SMDなど）を添える。

- 観察研究では「因果効果」と言い切らない。前提（交絡の取り切れなさ等）を明記する（`principles/compiled_principles.md`参照）。

## 図の出力ルール（必須）

> [!IMPORTANT]

> 図は **PNG(300dpi)** と **PDF(ベクター)** の両方で保存すること。

推奨：`ggsave()` を2回呼ぶ（同じ幅・高さ・テーマで統一）。保存先は各解析フォルダ配下。

## コーディング規約

-**スタイル**：tidyverse style guide（snake_case、パイプは `|>` または `%>%` のどちらかに統一）

-**コメント**：日本語（高校生にも分かる、短い言葉）

-**再現性**：乱数シード、主要パッケージ、必要なら `sessionInfo()` を残す

-**外部依存**：新しいパッケージ追加が必要なら先に相談（ネットワーク制限の可能性がある）

-**パッケージ**：主要パッケージは「使用可能なRパッケージ（主要）」参照。環境の確認は `scripts/verify_packages.R`。`docs/r_usage_examples.md` の追加パッケージは環境に無いことがあるため、代替案提示かインストール可否の確認を行う

- **スクリプトの整理**（重要）：試行錯誤の過程で一時的なファイルや別バージョンのスクリプト（例: `_v2`, `_simple` など）が作成された場合、タスク完了時に必ずこれらを整理・削除する。最終的に正しく動作するコードのみを残し、実行順序が分かるようにファイル名を連番で統一する（`01_...`, `02_...`）。

## ファイル命名規則（推奨）

| カテゴリ | パターン | 例 |

|---------|---------|-----|

| データ処理 | `[番号]_[動詞]_data.R` | `01_import_data.R`, `02_clean_data.R` |

| 解析 | `[番号]_[解析種類]_analysis.R` | `03_descriptive_analysis.R` |

| 可視化 | `[番号]_create_[対象].R` | `05_create_figures.R` |

| レポート | `[番号]_generate_report.R` | `06_generate_report.R` |

| ユーティリティ | `utils_[機能].R` | `utils_helper_functions.R` |

| 出力図（PNG） | `[対象]_[種類].png` | `survival_curve.png` |

| 出力図（PDF） | `[対象]_[種類].pdf` | `survival_curve.pdf` |

## 新規解析追加のワークフロー（推奨）

1.`scripts/<analysis_name>/` を作成（例：`scripts/new_analysis/`）

2.`00_readme.md`（目的・データ・アウトカム・主要解析）か `report.md` を最初に作る

3. 小さく動く `01_import_data.R` → `02_clean_data.R` → `03_descriptive_analysis.R` の順に増やす
4. 出力（表/図/中間CSV）は同フォルダ内に保存し、ファイル名で内容が分かるようにする

## データ取り扱い（機密・個人情報）

- 機密データはコミットしない。必要なら `data/private/` のようなフォルダに置き、`.gitignore` に追加する。
- 実データを前提にコードを書く前に、**サンプル（合成）データで動作確認**してから本番に適用する。

## 最低限の禁止事項

- 実行していない解析結果（数値・p値・図）を捏造しない
- 観察研究で因果を断定しない（言い回しと前提を明記）
- p値だけで結論を出さない（推定値＋CIを必ず併記）
